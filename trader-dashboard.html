<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trader Dashboard â€¢ VANCROX</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./trader.css"/>
</head>

<body>

<header class="topbar">
  <div class="brand">
    <img src="./assets/logo.png" class="logo"/>
    <div>
      <div class="bname">VANCROX</div>
      <div class="btag">Professional Trader Panel</div>
    </div>
  </div>

  <div class="top-right">
    <div class="chip">
      <div class="chip-label">Trader ID</div>
      <div class="chip-value" id="tid">TID----</div>
    </div>
    <div class="chip">
      <div class="chip-label">Security Money</div>
      <div class="chip-value" id="security">$0.00</div>
    </div>
    <div class="chip green">
      <div class="chip-label">Total Earnings</div>
      <div class="chip-value" id="earning">$0.00</div>
    </div>
  </div>
</header>

<main class="layout">

  <aside class="sidebar">
    <div class="profile">
      <div class="avatar" id="avatar">T</div>
      <div>
        <div class="pname" id="tName">Trader</div>
        <div class="plevel">Level <b id="level">1</b></div>
      </div>
    </div>

    <nav class="nav">
      <button class="nav-btn active" onclick="go('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="go('ads')">Run Ad Free</button>
      <button class="nav-btn" onclick="go('inventory')">My Inventory</button>
      <button class="nav-btn" onclick="go('history')">History</button>
      <button class="nav-btn" onclick="go('menu')">Menu</button>
    </nav>

    <button class="logout" onclick="logout()">Logout</button>
  </aside>

  <section class="content" id="content"></section>
</main>

<div class="modal hidden" id="modal">
  <div class="modal-card" id="modalCard"></div>
</div>

<div class="toast" id="toast"></div>

<script>
const API = "https://vancrox-backend.onrender.com";
const token = new URL(location.href).searchParams.get("token");
if(!token){ location.href="./login.html"; }

const content = document.getElementById("content");
const toast = document.getElementById("toast");
const modal = document.getElementById("modal");
const modalCard = document.getElementById("modalCard");

function showToast(t){
  toast.innerText=t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}
function openModal(h){ modalCard.innerHTML=h; modal.classList.remove("hidden"); }
function closeModal(){ modal.classList.add("hidden"); }
function logout(){ location.href="./login.html"; }

async function api(path,method="GET",body){
  const r = await fetch(API+path,{
    method,
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+token
    },
    body: body?JSON.stringify(body):null
  });
  return r.json();
}

let STATE={tab:"dashboard", trader:null, security:0, earning:0, trades:0};

function go(t){ STATE.tab=t; render(); }

async function loadProfile(){
  const d = await api("/api/trader/profile");
  STATE.trader=d.trader;
  document.getElementById("tName").innerText=d.trader.name;
  document.getElementById("tid").innerText="TID"+d.trader.tid;
  document.getElementById("avatar").innerText=d.trader.name[0];
}

async function loadSummary(){
  const d = await api("/api/trader/history");
  const tx=d.tx||[];
  STATE.security=tx.filter(x=>x.type==="SECURITY"&&x.status==="SUCCESS")
    .reduce((s,x)=>s+Number(x.amount),0);
  STATE.earning=tx.filter(x=>x.type==="TRADER_EARNING")
    .reduce((s,x)=>s+Number(x.amount),0);
  STATE.trades=tx.filter(x=>x.type==="TRADER_EARNING").length;

  document.getElementById("security").innerText="$"+STATE.security.toFixed(2);
  document.getElementById("earning").innerText="$"+STATE.earning.toFixed(2);
  document.getElementById("level").innerText=Math.floor(STATE.trades/10)+1;
}

function render(){
  if(STATE.security<100){
    content.innerHTML=`
      <div class="card center">
        <h2>Security Deposit Required</h2>
        <p class="muted">Minimum 100 USDT required</p>
        <button class="btn full" onclick="deposit()">Deposit Security Money</button>
      </div>`;
    return;
  }

  if(STATE.tab==="dashboard"){
    content.innerHTML=`
      <div class="grid3">
        <div class="card"><div class="k">Security</div><div class="v">$${STATE.security}</div></div>
        <div class="card"><div class="k">Earnings</div><div class="v green">$${STATE.earning}</div></div>
        <div class="card"><div class="k">Trades</div><div class="v">${STATE.trades}</div></div>
      </div>`;
  }

  if(STATE.tab==="ads"){
    content.innerHTML=`
      <div class="card">
        <h3>Run Ad Free</h3>
        <p class="muted">Ad amount = Security Money</p>
        <button class="btn" onclick="createAd()">Create Ad</button>
      </div>`;
  }

  if(STATE.tab==="inventory"){
    content.innerHTML=`
      <div class="card">
        <h3>My Inventory</h3>
        <div class="muted">Waiting for trader confirmation / profit / loss</div>
      </div>`;
  }

  if(STATE.tab==="history"){
    content.innerHTML=`
      <div class="card">
        <h3>Earnings History</h3>
        <p class="muted">Only profit earnings shown here</p>
      </div>`;
  }

  if(STATE.tab==="menu"){
    content.innerHTML=`
      <div class="card">
        <button class="btn full">Withdrawal Address</button>
        <button class="btn ghost full">Change Password</button>
        <button class="btn ghost full">Help / Support</button>
        <button class="btn danger full">Close Account</button>
      </div>`;
  }
}

function deposit(){
  openModal(`
    <h3>Deposit Security Money</h3>
    <input id="amt" placeholder="Min 100"/>
    <button class="btn full" onclick="submit()">Submit</button>
  `);
}
async function submit(){
  const amt=document.getElementById("amt").value;
  await api("/api/trader/security-deposit","POST",{amount:amt});
  closeModal(); showToast("Requested"); loadSummary(); render();
}

(async()=>{
  await loadProfile();
  await loadSummary();
  render();
})();
</script>

</body>
</html>