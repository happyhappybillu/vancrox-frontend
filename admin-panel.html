<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VANCROX • Master Control Panel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./admin.css"/>
  <style>
    /* कुछ ज़रूरी स्टाइल जो शायद admin.css में न हों */
    .status-pill { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .bg-red { background: #ff4d4d; color: white; }
    .bg-green { background: #2ecc71; color: white; }
    .bg-yellow { background: #f1c40f; color: black; }
    .action-btns { display: flex; gap: 5px; }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="brand">
      <img src="./assets/logo.png" class="logo" alt="VANCROX"/>
      <div>
        <div class="bname">VANCROX</div>
        <div class="btag">Master Dashboard • Live Server</div>
      </div>
    </div>

    <div class="top-actions">
      <div class="small">Admin: <b id="adminName">Loading...</b></div>
      <button class="btn ghost" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="layout">
    <aside class="side">
      <div class="side-title">Management</div>
      <button class="nav active" id="navInv" onclick="go('investors')">Investors List</button>
      <button class="nav" id="navTr" onclick="go('traders')">Traders List</button>
      <button class="nav" id="navPend" onclick="go('pending')">Pending Requests</button>
      <button class="nav" id="navSup" onclick="go('support')">Support Tickets</button>
      <button class="nav" id="navAddr" onclick="go('address')">System Wallets</button>
      <button class="nav" id="navPass" onclick="go('password')">Admin Security</button>
    </aside>

    <section class="content" id="content">
        <div class="center2">Loading data from Vancrox Server...</div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script src="./auth.js"></script>
  <script>
    // 1. एडमिन चेक (role "admin" होना ज़रूरी है)
    requireAuth("admin"); 

    const content = document.getElementById("content");
    const adminNameDisplay = document.getElementById("adminName");
    
    // लोकल सर्वर या रेंडर का URL (अपनी ज़रूरत अनुसार बदलें)
    const API_BASE = "http://localhost:5000/api"; 

    // एडमिन का नाम दिखाना
    const currentAdmin = JSON.parse(localStorage.getItem("vancrox_auth"));
    if(currentAdmin) adminNameDisplay.innerText = currentAdmin.name || "Main Admin";

    function showToast(msg){
      const t = document.getElementById("toast");
      t.innerText = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2500);
    }

    // ====== LIVE DATA FETCHING ======
    async function apiCall(path, method = "GET", body = null) {
        const auth = JSON.parse(localStorage.getItem("vancrox_auth"));
        const headers = { 
            "Content-Type": "application/json",
            "Authorization": `Bearer ${auth.token}`
        };
        try {
            const res = await fetch(`${API_BASE}${path}`, { method, headers, body: body ? JSON.stringify(body) : null });
            return await res.json();
        } catch (e) {
            showToast("Server Connection Failed");
            return { success: false };
        }
    }

    // ====== NAVIGATION ======
    let currentTab = "investors";
    function go(t){
      currentTab = t;
      document.querySelectorAll(".nav").forEach(x => x.classList.remove("active"));
      const navMap = { investors: 'navInv', traders: 'navTr', pending: 'navPend', support: 'navSup', address: 'navAddr', password: 'navPass' };
      if(navMap[t]) document.getElementById(navMap[t]).classList.add("active");
      render();
    }

    // ====== INVESTOR LIST ======
    async function renderInvestors(){
      content.innerHTML = "<div class='center2'>Fetching Investors...</div>";
      const res = await apiCall("/admin/users?role=investor"); // ये API बैकएंड में बनानी होगी
      
      if(!res.success) return content.innerHTML = "<div class='center2'>Error loading users.</div>";

      content.innerHTML = `
        <div class="page">
          <h2>Investor Management</h2>
          <div class="card">
            <div class="table">
              <div class="thead"><div>UID</div><div>Name</div><div>Balance</div><div>Status</div><div>Actions</div></div>
              ${res.users.map(u => `
                <div class="trow">
                  <div><b>UID-${u.uid}</b></div>
                  <div>${u.name}</div>
                  <div>$${Number(u.balance || 0).toFixed(2)}</div>
                  <div><span class="status-pill ${u.isBlocked ? 'bg-red' : 'bg-green'}">${u.isBlocked ? 'BLOCKED' : 'ACTIVE'}</span></div>
                  <div class="action-btns">
                    <button class="btn sm" onclick="toggleBlockUser('${u._id}', ${u.isBlocked})">${u.isBlocked ? 'Unblock' : 'Block'}</button>
                  </div>
                </div>
              `).join("") || "No Investors Found"}
            </div>
          </div>
        </div>
      `;
    }

    // ====== PENDING REQUESTS ======
    async function renderPending(){
        content.innerHTML = "<div class='center2'>Checking Pending Transactions...</div>";
        const res = await apiCall("/admin/pending"); // ये API बैकएंड में बनानी होगी

        content.innerHTML = `
            <div class="page">
                <h2>Pending Balance Requests</h2>
                <div class="card">
                    ${!res.list || res.list.length === 0 ? "<div class='muted center2'>No pending requests!</div>" : 
                    res.list.map(p => `
                        <div class="rowitem">
                            <div>
                                <div class="b">${p.userId} (${p.type})</div>
                                <div class="muted">Amount: $${p.amount} | Date: ${new Date(p.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div class="actions">
                                <button class="btn sm" onclick="updateTx('${p._id}', 'success')">Approve</button>
                                <button class="btn danger sm" onclick="updateTx('${p._id}', 'failed')">Reject</button>
                            </div>
                        </div>
                    `).join("")}
                </div>
            </div>
        `;
    }

    // ====== SYSTEM WALLETS ======
    async function renderAddress(){
      // यहाँ हम डेटाबेस से वॉलेट एड्रेस मंगवाएंगे
      content.innerHTML = `
        <div class="page">
          <h2>System Wallet Management</h2>
          <p class="muted">ये एड्रेस सभी यूज़र्स को उनके डिपॉजिट पेज पर दिखेंगे।</p>
          <div class="card">
            <label class="lbl">USDT (TRC20)</label>
            <input id="trc20" placeholder="Enter TRC20 Address" value="Fetching..."/>
            <label class="lbl">USDT (ERC20)</label>
            <input id="erc20" placeholder="Enter ERC20 Address"/>
            <button class="btn full" onclick="saveWallets()">Update All Addresses</button>
          </div>
        </div>
      `;
    }

    // ====== FUNCTIONS FOR ACTIONS ======
    async function toggleBlockUser(userId, currentStatus){
        const res = await apiCall(`/admin/block/${userId}`, "POST", { block: !currentStatus });
        if(res.success) {
            showToast("User Status Updated");
            render();
        }
    }

    async function updateTx(txId, status){
        const res = await apiCall(`/admin/transaction/${txId}`, "POST", { status });
        if(res.success) {
            showToast("Transaction Updated");
            render();
        }
    }

    function render(){
      if(currentTab === "investors") renderInvestors();
      if(currentTab === "pending") renderPending();
      if(currentTab === "address") renderAddress();
      // बाकी फंक्शन्स भी इसी तरह जुड़ेंगे...
    }

    render();
  </script>
</body>
</html>
