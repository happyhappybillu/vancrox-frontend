<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Investor Dashboard â€¢ VANCROX</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./investor.css" />
</head>

<body>
  <div class="bg-orbs"></div>
  <div class="bg-grid"></div>
  <div id="particles"></div>

  <!-- HEADER -->
  <header class="dash-header">
    <div class="left">
      <button class="menu-btn" id="menuBtn">â˜°</button>

      <button class="notif-btn" onclick="openNotifications()">ðŸ””</button>

      <div class="profile" id="profileBtn">
        <img id="profileImg" src="./assets/default-user.png"/>
        <div class="profile-meta">
          <div class="welcome">Welcome back</div>
          <div class="name" id="userName">...</div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="uid-box">
        <div class="uid-label">User ID</div>
        <div class="uid" id="userId">UID000000</div>
      </div>
    </div>
  </header>

  <!-- MENU -->
  <aside class="drawer" id="drawer">
    <div class="drawer-top">
      <div class="drawer-title">Menu</div>
      <button class="drawer-close" id="closeDrawer">âœ•</button>
    </div>

    <button class="drawer-item" onclick="openWithdrawAddress()">Withdrawal Address</button>
    <button class="drawer-item" onclick="openChangePassword()">Change Password</button>
    <button class="drawer-item" onclick="openSupport()">Help / Support</button>

    <div class="drawer-line"></div>
    <button class="drawer-item danger" onclick="logout()">Logout</button>
  </aside>

  <!-- PROFILE POP -->
  <div class="profile-pop" id="profilePop">
    <button onclick="openProfileEdit()">Edit Profile</button>
    <button class="danger" onclick="logout()">Logout</button>
  </div>

  <!-- MAIN -->
  <main class="container" id="screen"></main>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <button class="nav-item active" id="navHome" onclick="goTab('home')">Home</button>
    <button class="nav-item" id="navChart" onclick="goTab('chart')">Chart View</button>
    <button class="nav-item" id="navTraders" onclick="goTab('traders')">My Traders</button>
    <button class="nav-item" id="navHistory" onclick="goTab('history')">History</button>
  </nav>

  <!-- MODAL -->
  <div class="modal hidden" id="modal">
    <div class="modal-card" id="modalCard"></div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

<script>
/* ================= TOKEN ================= */
const API = "https://vancrox-backend.onrender.com";
const TOKEN = new URLSearchParams(window.location.search).get("token");
if(!TOKEN){ location.href="./login.html"; }

/* ================= HELPERS ================= */
const screen = document.getElementById("screen");
const modal = document.getElementById("modal");
const modalCard = document.getElementById("modalCard");
const toast = document.getElementById("toast");

function showToast(t){
  toast.innerText=t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}
function openModal(h){ modalCard.innerHTML=h; modal.classList.remove("hidden"); }
function closeModal(){ modal.classList.add("hidden"); modalCard.innerHTML=""; }
modal.onclick=e=>{ if(e.target.id==="modal") closeModal(); };

async function api(path,method="GET",body){
  const r = await fetch(API+path,{
    method,
    headers:{ "Content-Type":"application/json","Authorization":"Bearer "+TOKEN },
    body: body?JSON.stringify(body):null
  });
  const d = await r.json().catch(()=>({}));
  return {ok:r.ok,data:d};
}

/* ================= STATE ================= */
const state = {
  tab:"home",
  user:{},
  balance:0,
  ads:[],
  myTrades:[],
  history:[]
};

/* ================= INIT ================= */
(async()=>{
  const me = await api("/api/auth/me");
  if(!me.ok) return logout();

  state.user = me.data.user;
  document.getElementById("userName").innerText = state.user.name;
  document.getElementById("userId").innerText = "UID"+state.user.uid;

  loadAll();
})();

/* ================= LOAD ================= */
async function loadAll(){
  const hist = await api("/api/investor/history");
  state.history = hist.data?.tx||[];

  let bal=0;
  state.history.forEach(t=>{
    if(t.status==="SUCCESS"){
      if(t.type==="DEPOSIT") bal+=t.amount;
      if(t.type==="WITHDRAW") bal-=t.amount;
      if(t.type==="PROFIT") bal+=t.amount;
    }
  });
  state.balance=bal;

  const ads = await api("/api/investor/top-traders");
  state.ads = ads.data?.ads||[];

  const my = await api("/api/investor/my-traders");
  state.myTrades = my.data?.list||[];

  render();
}

/* ================= NAV ================= */
function goTab(t){ state.tab=t; render(); }
function render(){
  if(state.tab==="home") renderHome();
  if(state.tab==="chart") renderChart();
  if(state.tab==="traders") renderMyTraders();
  if(state.tab==="history") renderHistory();
}

/* ================= HOME ================= */
function renderHome(){
screen.innerHTML=`
<div class="balance-card">
  <div class="bal-label">TOTAL BALANCE</div>
  <div class="bal-amt">$${state.balance}</div>
  <div class="bal-note green">100% Refund Guarantee<br/>If trader makes loss</div>
</div>

<h3>Top Traders</h3>
${state.ads.length===0?`<div class="empty">No active traders</div>`:
state.ads.map(a=>`
<div class="card">
  <b>${a.traderId.name}</b>
  <div>Trade${a.minAmount}$</div>
  <div>Return ${a.profitPercent}%</div>
  <button onclick="hire('${a._id}',${a.minAmount})">Hire</button>
</div>
`).join("")}
`;
}

function hire(adId,amt){
  if(state.balance<amt) return showToast("Low balance");
  openModal(`
    <h3>Confirm Trade</h3>
    <p>Trade${amt}$</p>
    <button onclick="confirmHire('${adId}')">Confirm</button>
    <button onclick="closeModal()">Cancel</button>
  `);
}
async function confirmHire(id){
  await api("/api/investor/hire","POST",{traderAdId:id});
  closeModal(); showToast("Trade started"); loadAll();
}

/* ================= CHART ================= */
function renderChart(){
screen.innerHTML=`
<iframe src="https://s.tradingview.com/widgetembed/?symbol=XAUUSD&interval=15&theme=dark" width="100%" height="300"></iframe>
<iframe src="https://s.tradingview.com/widgetembed/?symbol=BTCUSDT&interval=15&theme=dark" width="100%" height="300"></iframe>
`;
}

/* ================= MY TRADERS ================= */
function renderMyTraders(){
screen.innerHTML = state.myTrades.length===0
? `<div class="empty">No active trades</div>`
: state.myTrades.map(t=>`
<div class="card">
<b>${t.traderId.name}</b>
<div>Status: ${t.status}</div>
${t.status==="PROFIT"?`<div class="green">Profit Added</div>`:""}
</div>
`).join("");
}

/* ================= HISTORY ================= */
function renderHistory(){
screen.innerHTML = state.history.map(h=>`
<div class="history-card">
<b>${h.type}</b> $${h.amount}
<div>${new Date(h.createdAt).toLocaleString()}</div>
</div>
`).join("") || `<div class="empty">No history</div>`;
}

/* ================= NOTIFICATIONS ================= */
async function openNotifications(){
  const n = await api("/api/investor/notifications");
  openModal(`
    <h3>Notifications</h3>
    ${(n.data.list||[]).map(x=>`
      <div class="notif-card">
        <b>${x.title}</b>
        <p>${x.message}</p>
      </div>
    `).join("")||"No notifications"}
  `);
}

/* ================= OTHERS ================= */
function logout(){ location.href="./login.html"; }
</script>
</body>
</html>