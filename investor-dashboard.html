<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Investor Dashboard â€¢ VANCROX</title>

  <!-- FONT -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- CSS -->
  <link rel="stylesheet" href="./investor.css" />
</head>

<body>

<!-- ================= PREMIUM BACKGROUND ================= -->
<div class="bg-orbs"></div>
<div class="bg-grid"></div>
<div id="particles"></div>

<!-- ================= HEADER ================= -->
<header class="dash-header">
  <div class="left">
    <button class="menu-btn" id="menuBtn">â˜°</button>

    <div class="profile" id="profileBtn">
      <img id="profileImg" src="./assets/default-user.png" />
      <div class="profile-meta">
        <div class="welcome">Welcome back</div>
        <div class="name" id="userName">Loading...</div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="uid-box">
      <div class="uid-label">User ID</div>
      <div class="uid" id="userId">UID----</div>
    </div>
  </div>
</header>

<!-- ================= DRAWER MENU ================= -->
<aside class="drawer" id="drawer">
  <div class="drawer-top">
    <div class="drawer-title">Menu</div>
    <button class="drawer-close" id="closeDrawer">âœ•</button>
  </div>

  <button class="drawer-item" onclick="openWithdrawAddress()">Withdrawal Address</button>
  <button class="drawer-item" onclick="openChangePassword()">Change Password</button>
  <button class="drawer-item" onclick="openSupport()">Help / Support</button>

  <div class="drawer-line"></div>
  <button class="drawer-item danger" onclick="logout()">Logout</button>
</aside>

<!-- ================= PROFILE POP ================= -->
<div class="profile-pop" id="profilePop">
  <button onclick="openProfileEdit()">Edit Profile</button>
  <button class="danger" onclick="logout()">Logout</button>
</div>

<!-- ================= MAIN CONTAINER ================= -->
<main class="container" id="screen"></main>

<!-- ================= BOTTOM NAV ================= -->
<nav class="bottom-nav">
  <button class="nav-item active" id="navHome" onclick="goTab('home')">Home</button>
  <button class="nav-item" id="navChart" onclick="goTab('chart')">Chart View</button>
  <button class="nav-item" id="navTraders" onclick="goTab('traders')">My Traders</button>
  <button class="nav-item" id="navHistory" onclick="goTab('history')">History</button>
</nav>

<!-- ================= MODAL ================= -->
<div class="modal hidden" id="modal">
  <div class="modal-card" id="modalCard"></div>
</div>

<!-- ================= TOAST ================= -->
<div class="toast" id="toast"></div>

<script src="./auth.js"></script>
<script>requireAuth("investor");
  
</script>
<script src="./investor.js"></script>
<script>

/* ================= PARTICLES ================= */
const particles = document.getElementById("particles");
for(let i=0;i<80;i++){
  const p=document.createElement("span");
  p.className="particle";
  p.style.left=Math.random()*100+"%";
  p.style.top=Math.random()*100+"%";
  p.style.animationDelay=(Math.random()*10)+"s";
  p.style.animationDuration=(8+Math.random()*12)+"s";
  particles.appendChild(p);
}

/* ================= AUTH FIX (IMPORTANT) ================= */
const AUTH = JSON.parse(localStorage.getItem("vancrox_auth"));

if(!AUTH || !AUTH.token || AUTH.role !== "investor"){
  location.href = "./login.html";
}

/* ================= CONFIG ================= */
const API_BASE = "https://vancrox-backend.onrender.com";

/* ================= HELPERS ================= */
const screen = document.getElementById("screen");
const modal = document.getElementById("modal");
const modalCard = document.getElementById("modalCard");
const toast = document.getElementById("toast");

function showToast(t){
  toast.innerText=t;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2800);
}
function openModal(h){ modalCard.innerHTML=h; modal.classList.remove("hidden"); }
function closeModal(){ modal.classList.add("hidden"); modalCard.innerHTML=""; }
modal.onclick=e=>{ if(e.target.id==="modal") closeModal(); };

async function api(path,method="GET",body){
  const r = await fetch(API_BASE+path,{
    method,
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+AUTH.token
    },
    body: body?JSON.stringify(body):null
  });
  const d = await r.json().catch(()=>({}));
  return {ok:r.ok,data:d};
}

/* ================= STATE ================= */
const state={
  tab:"home",
  balance:0,
  user:{name:"Investor",uid:0,profilePhoto:""},
  topTraders:[],
  myTrades:[],
  history:[]
};

/* ================= MENU ================= */
const drawer=document.getElementById("drawer");
menuBtn.onclick=()=>drawer.classList.add("open");
closeDrawer.onclick=()=>drawer.classList.remove("open");

const profilePop=document.getElementById("profilePop");
profileBtn.onclick=()=>profilePop.classList.toggle("open");
document.addEventListener("click",e=>{
  if(!e.target.closest("#profileBtn")&&!e.target.closest("#profilePop")){
    profilePop.classList.remove("open");
  }
});

function logout(){
  localStorage.removeItem("vancrox_auth");
  location.href="./login.html";
}

/* ================= NAV ================= */
function goTab(t){
  state.tab=t;
  render();
}
function setActive(){
  ["home","chart","traders","history"].forEach(x=>{
    document.getElementById("nav"+x.charAt(0).toUpperCase()+x.slice(1)).classList.remove("active");
  });
  document.getElementById("nav"+state.tab.charAt(0).toUpperCase()+state.tab.slice(1)).classList.add("active");
}

/* ================= LOAD ================= */
async function loadAll(){
  const me=await api("/api/auth/me");
  if(!me.ok){logout();return;}

  state.user=me.data.user;
  userName.innerText=state.user.name;
  userId.innerText="UID"+state.user.uid;
  if(state.user.profilePhoto) profileImg.src=state.user.profilePhoto;

  const hist=await api("/api/investor/history");
  state.history=hist.data?.tx||[];

  let bal=0;
  state.history.forEach(t=>{
    if(t.status==="SUCCESS"){
      if(t.type==="DEPOSIT") bal+=t.amount;
      if(t.type==="WITHDRAW") bal-=t.amount;
      if(t.type==="PROFIT") bal+=t.amount;
    }
  });
  state.balance=bal;

  const ads=await api("/api/investor/top-traders");
  state.topTraders=ads.data?.ads||[];

  const my=await api("/api/investor/my-traders");
  state.myTrades=my.data?.list||[];

  render();
}

/* ================= RENDER ================= */
function render(){
  setActive();
  if(state.tab==="home") renderHome();
  if(state.tab==="chart") renderChart();
  if(state.tab==="traders") renderMyTraders();
  if(state.tab==="history") renderHistory();
}

/* ================= à¤¬à¤¾à¤•à¥€ à¤•à¤¾ code (HOME / CHART / HISTORY / TILT / etc)
   ðŸ‘‰ EXACT SAME AS YOUR FILE â€“ NOTHING CHANGED
================================================ */

loadAll();
</script>
</body>
</html>